name: php
version: '8.4'

summary: A popular general-purpose scripting language that is especially suited to web development.
description: |
    PHP is a general-purpose scripting language well-suited for Web
    development. Fast, flexible and pragmatic, PHP powers everything
    from your blog to the most popular websites in the world.

    This image is a chiselled Ubuntu rock that contains only the PHP interpreter
    and its core dependencies, no additional modules available.

base: bare
# TODO: Update to 25.04 when available
build-base: ubuntu@24.04

run-user: _daemon_

platforms:
    amd64:
    arm64:

parts:
    php:
        plugin: nil
        source: https://github.com/alesancor1/chisel-releases.git
        source-type: git
        source-branch: 25.04/php
        override-build: |
            chisel cut --release ./ --root ${CRAFT_PART_INSTALL} \
                base-files_base \
                base-files_release-info \
                base-files_chisel \
                php_core

    # TODO waiting for chisel-releases PR
    # php:
    #     plugin: nil
    #     stage-packages:
    #         - base-files_base
    #         - base-files_release-info
    #         - base-files_chisel
    #         - php_core

    manifest:
        plugin: nil
        after: [php]
        build-packages:
            - zstd
            - jq
        override-build: |
            mkdir -p $CRAFT_PART_INSTALL/usr/share/rocks
            FIELDS=(
                '${db:Status-Abbrev}'
                '${binary:Package}'
                '${Version}'
                '${source:Package}'
                '${Source:Version}\n'
            )
            zstd -d -f -q $CRAFT_STAGE/var/lib/chisel/manifest.wall \
                -o $CRAFT_PART_BUILD/manifest

            # Awk fortmat
            awk_script='
            {
                binary=$1
                version=$2
                cmd = "dpkg-query -W -f='\''${source:Package}\n'\'' " binary " | head -n 1"
                if ((cmd | getline source) > 0) {
                    print "ii ," binary ":" arch "," version "," source "," version
                }
                close(cmd)
            }'

            # Create security manifest file
            (echo "# os-release" && cat /etc/os-release && echo "# dpkg-query") \
            > $CRAFT_PART_INSTALL/usr/share/rocks/dpkg.query

            # Add packages
            (
                awk -v arch=${CRAFT_ARCH_BUILD_FOR} -F' ' "$awk_script" <<< \
                $(
                    jq -r 'select(.kind == "package") | "\(.name) \(.version)"' \
                    $CRAFT_PART_BUILD/manifest
                )
            ) >> $CRAFT_PART_INSTALL/usr/share/rocks/dpkg.query

            craftctl default
